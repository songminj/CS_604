# CH3 네트워크계층

## 3-1 LAN을 넘어서는 네트워크 계층

### 데이터 링크 계층의 한계 

- 물리계층과 데이터링크 계층만으로는 다른 도시나 국가의 친구와 통신할 수 없다 
  - 물리계층과 데이터링크 계층만으로는 다른 네트워크까지의 도달 경로를 파악하기 어렵다. 
    - 중간에 수많은 네트워크 장비를 거쳐야 하는데 이걸 알지 못함 
    - 라우팅 : 패킷이 이동할 최적의 경로를 결정하는 것 
    - 라우터 : 라우팅을 수행하는 장비 
  - MAC주소 만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어렵다 
    - 모든 호스트의 MAC주소를 서로 알고있기는 어렵다. 


### 인터넷 프로토콜(Internet Protocol)

- IP주소는 4바이트로 주소를 표현할 수 있도 숫자당 8비트 이기 때문에 0~255범위 안에 있는 네개의 10진수로 표기된다. 
  - 숫자를 옥텟이라고 한다 
- IP의 기능은 주소지정과 단편화이다. 
  - IP주소 지정 : IP주소를 바탕으로 송수신 대상을 지정하는 것 
  - IP 단편화 : 패킷의 크기가 MTU라는 최대 전송 단위보다 클 때 복수의 패킷으로 나누는 것. 
    - MTU : 한번에 전송가능한 IP패킷의 최대 크기를 의미하고 일반적으로 1500바이트이다. 

### IPv4

- IPv4의 패킷은 프레임의 페이로드로 데이터 필드에 명시된다. 

- IP단편화 기능에 관여 
1. 식별자 
   - 패킷에 할당된 번호이다. 
   - 패킷이 쪼개져서 수신지에 도착했을 때 어떤 메세지에서 쪼개졌는지 확인하는 용도이다. 
2. 플래그 
   - 세개의 비트로 구성되었다. 
   - 기능을 하는 비트 두개를 사용하고 나머지는 0으로 안쓰는 비트이다. DF의 비트가 1이면 단편화를 하지 않고 0이면 단편화가 가능하다. 
   - MF라는 비트는 단편화된 패킷이 더 있는지 알려준다. 0이면 이 패킷이 마지막인것이고 1이면 쪼개진 패킷이 아직 더 있는 것이다. 
3. 단편화 오프셋
   - 패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇번째로 떨어진 패킷인지를 나타낸다. 

<br>

4. TTL
   - Time To Live의 약어로 패킷의 수명을 의미한다. 
   - 패킷은 여러 라우터를 거치며 이동하는데 이때 TTL이 1씩 감소하고 0이되면 폐기된다. 
   - 패킷이 호스트나 라우터에 한번 전달되는것을 홉(hop)이라고 한다. 
   - 무의미한 패킷이 네트워크 상에 지속적으로 남아있는 것을 방지하기 위함이다. 
5. 프로토콜 
   - IP 패킷의 프로토콜을 상위 계층의 프로토콜이 무엇인지 나타낸다.
   - TCP는 6번 UDP는 17번이다

<br>

- IP주소 지정에 관여 
6. 송신지 IP주소 
7. 수신지 IP주소


### IPv6

- IPv4 다써서 나온 숫자 
- 16바이트(128비트)로 주소를 표현할 수 있고 : (콜론) 으로 구분된 8개 그룹의 16진수로 표기한다. 


### IPv6의 기본 헤더 

1. 다음 헤더 
   - 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가리킨다. 
   - 추가 헤더가 필요할 때 확장헤더를 가질 수 있다. 
2. 홉 제한
   - IPv4패킷의 TTL필드와 비슷하게 패킷의 수명을 나타내는 필드이다.
3. 송신지 IP주소
4. 수신지 IP주소


### ARP

- 상대 호스트의 IP주소는 알지만 MAC주소는 알지 못하는 상황에 ARP를 사용한다 
- ARP요청 -> 응답 -> ARP테이블 갱신의 동작과정을 거친다. 

<br>

1. ARP 요청 
  - 네트워크 내의 모든 호스트에게 브로드캐스트로 메세지를 보낸다 
  - 예를들어 '10.0.0.2랑 통신하고 싶은데 이분 MAC주소 아시는분~ '이런식
2. ARP 응답
  - 해당하는 호스트가 자신의 MAC주소를 담은 메시지를 A에게 전송한다. 
3. ARP 테이블 갱신
   - 받은 MAC주소 정보를 추가한다. 
    ```bash
    arp -a
    ```

### 통신하려는 호스트가 서로 다른 네트워크에 있으면?

- 이럴때는 라우터끼리 ARP요청을 전달하고 전달 받아야한다. 

### IP 단편화는 되도록 하지 않는것이 좋다 

- 전송해야하는 패킷헤더가 늘어난다. 
  - 불필요한 트래픽 증가와 대역폭 낭비 
- 패킷을 합치는 과정에서의 부하도 성능 저하를 만들 수 있다. 
- 처리가능한 MTU크기를 고려해야한다. 

## 3-2 IP주소 
- IP주소는 논리 주소라고 한다. 
  - DHPC라는 특정 프로토콜을 통해 자동으로 할당받거나 사용자가 직접 할당할 수 있다. 
- 네트워크 주소와 호스틑 주소로 이루어진다. 
  - 호스트와 네트워크 주소의 구분범위는 유동적인데 적절하게 할당을 해야하고 이럴 고민을 해결하기 위해 생겨난 개념이 클래스이다. 


### 클래스 주소 체계 


### 클래스리스 주소 체계 

- 클래스별 네트워크의 크기가 고정되어 있기 때문에 여전히 다수의 IP주소가 낭비된다. 
- 만약 300명이 쓸 주소체계를 고른다면 254개뿐인 C를 선택하지 못하고 6만개인 B를 선택해야 한다. 


### 서브넷 마스크 
- IP주소상에서 네트워크 주소를 1, 호스트주소를 0으로 표기한 비트열을 의미한다. 
- 클래스리스는 서브넷 마스크를 이용해 네트워크 주소와 호스트 주소를 구분한다. 

### CIDR 표기법 

- 서브넷 마스크를 IP주소/서브넷마스크상의 1의 개수 형식으로 표기하는 방법이다. 
- 예를들어 IP주소 192.168.219.103과 서브넷 마스크 255.255.255.0은 192.168.219.103/24로 표기한다. 
- 그리고 서브넷 마스크와 IP주소를 비트 AND연산하면 나오는 결과가 네트워크 주소이다. 


### 공인 IP주소와 사설 IP주소 
- 공인 IP주소 : 전세계에서 고유한 IP주소이다. 
- 사설 IP주소 : 사설 네트워크에서 사용하기 위한 IP주소이다. 
  - 외부 네트워크에 공개되지 않은 네트워크
  - 일반적으로 라우터를 할당 주체로 한다.  


### 정적 IP주소와 동적 IP주소 

- 정적 할당 
  - 호스트에게 직접 수작업으로 IP주소를 부여하는 방식. 
  - 일반적으로 부여하고자 하는 IP주소, 서브넷 마스크, 게이트웨이(라우터)주소, DNS주소를 입력한다 
  - 그러면 해당 호스트는 입력한 IP주소에 해당하는 고정된 주소를 갖게 된다. 

- 동적 할당
  - 호스트의 수가 많아질 경우 관리가 어렵다 
  - 호스트에 IP주소가 동적으로 할당되는 방식이다. 
  - 주소를 사용하지 않을 경우 회수되고, 할당받을 떄마다 달느 주소를 받을 수 있다. 
  - DHCP : 동적할당에 사용되는 프로토콜
  
### DHCP를 통한 주소 할당 

- DHCP서버 간에 메세지를 주고받음으로써 이루어진다. 
- DHCP로 할당받은 IP주소는 임대기간이 정해져 있다. 
- 4가지 메시지를 주고받으며 IP주소를 할당한다. 

1. DHCP discover (클라이언트 -> DHCP서버)
   - 클라이언트는 이 메시지를 통해 DHCP서버를 찾는다 브로드캐스트로 전송된다. 
   - IP주소를 아직 할당받지 못해서 송신지 주소는 0.0.0.0이다
2. DHCP Offer (DHCP서버 -> 클라이언트)
   - 클라이언트에게 할장해 줄 IP주소를 제안하는 메시지를 준다
   - IP주소, 서브넷 마스크, 임대기간등의 정보도 함께 포함한다.
3. DHCP Request (클라이언트 -> DHCP서버)
   - DHCP offer에 대한 응답이다. 브로드캐스트로 전송된다. 
   - 이 IP주소 써도 되냐고 묻는거랑 같다. 
4. DHCP ACK (DHCP서버 -> 클라이언트)
   - DHCP서버는 클라이언트에게 최종승인 메시지를 보낸다. 
   - 그리고 임대기간동안 클라이언트는 할당받은 IP주소를 사용한다. 

임대기간이 끝나기 전에 임대 기간을 연장할 수도 있다. 

## 3-3 라우팅 

### 라우팅 

- 패킷이 이동할 최적의 경로를 설정하고 해당 경로로 패킷을 이동시키는 것 

### 라우터 
- 멀리 떨어져 있는 호스트 간의 통신 과정에서 패킷이 서로에게 도달할 수 있도록 거치는 과정에 도움을 주는 네트워크 장비이다. 
- 라우터-호스트, 라우터-라우터간의 이동을 '홉'이라고 한다. 
- `tracerouter {dns주소}` 로 홉이 몇개를 거치는지 알 수 있다. 

### 라우팅 테이블 

- 특정 수신지까지 도달하기 위한 정보를 명시한 표이다. 
- 